<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure GitHub Password Manager</title>
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#667eea">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .content {
            padding: 30px;
        }

        .setup-section, .main-section {
            display: none;
        }

        .setup-section.active, .main-section.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
        }

        input[type="text"], input[type="password"], input[type="url"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        input[type="text"]:focus, input[type="password"]:focus, input[type="url"]:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #545b62;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .password-list {
            margin-top: 30px;
        }

        .password-item {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            transition: all 0.3s;
        }

        .password-item:hover {
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        .password-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 10px;
        }

        .password-title {
            font-weight: 600;
            font-size: 16px;
            color: #333;
            flex-grow: 1;
        }

        .password-actions {
            display: flex;
            gap: 10px;
        }

        .password-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 15px;
        }

        .detail-item {
            display: flex;
            flex-direction: column;
        }

        .detail-label {
            font-size: 12px;
            color: #6c757d;
            margin-bottom: 5px;
            text-transform: uppercase;
            font-weight: 600;
        }

        .detail-value {
            font-family: monospace;
            background: white;
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #dee2e6;
            word-break: break-all;
        }

        .status {
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: 600;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .add-password-form {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
            display: none;
        }

        .add-password-form.active {
            display: block;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .password-details {
                grid-template-columns: 1fr;
            }
        }

        .sync-status {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        .sync-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #dc3545;
        }

        .sync-indicator.synced {
            background: #28a745;
        }

        .copy-btn {
            background: none;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 4px 8px;
            cursor: pointer;
            font-size: 12px;
            margin-left: 10px;
            transition: all 0.3s;
        }

        .copy-btn:hover {
            background: #e9ecef;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîê Secure Password Manager</h1>
            <p>Encrypted storage with GitHub sync</p>
        </div>
        
        <div class="content">
            <div id="setup-section" class="setup-section">
                <h2>Setup Your Password Manager</h2>
                <p style="margin-bottom: 20px; color: #6c757d;">Configure your GitHub connection and master password.</p>
                
                <form id="setup-form">
                    <div class="form-group">
                        <label for="github-token">GitHub Personal Access Token</label>
                        <input type="password" id="github-token" placeholder="ghp_xxxxxxxxxxxxxxxxxx" required>
                        <small style="color: #6c757d;">Token needs repo permissions for your private repository</small>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="repo-owner">Repository Owner</label>
                            <input type="text" id="repo-owner" placeholder="your-username" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="repo-name">Repository Name</label>
                            <input type="text" id="repo-name" placeholder="password-vault" required>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="master-password">Master Password</label>
                        <input type="password" id="master-password" placeholder="Choose a strong master password" required>
                        <small style="color: #6c757d;">This encrypts your passwords. Choose something strong and memorable.</small>
                    </div>
                    
                    <button type="submit" class="btn btn-primary">Initialize Password Manager</button>
                </form>
            </div>

            <div id="login-section" class="setup-section">
                <h2>Unlock Your Vault üóùÔ∏è</h2>
                <p style="margin-bottom: 20px; color: #6c757d;">Enter your Master Password to decrypt and access your passwords.</p>
                
                <form id="login-form">
                    <div class="form-group">
                        <label for="login-master-password">Master Password</label>
                        <input type="password" id="login-master-password" placeholder="Enter your Master Password" required>
                    </div>
                    
                    <button type="submit" class="btn btn-primary">Unlock</button>
                    <button type="button" id="reset-setup" class="btn btn-danger">Reset Setup</button>
                </form>
            </div>


            <div id="main-section" class="main-section">
                <div id="status" class="status" style="display: none;"></div>
                
                <div class="sync-status">
                    <div id="sync-indicator" class="sync-indicator"></div>
                    <span id="sync-text">Not synced</span>
                    <button id="sync-btn" class="btn btn-secondary">Sync with GitHub</button>
                    <button id="logout-btn" class="btn btn-secondary">Logout</button>
                </div>

                <div class="main-actions" style="margin-bottom: 20px;">
                    <button id="add-password-btn" class="btn btn-primary">Add New Password</button>
                    <button id="export-btn" class="btn btn-secondary">Export Backup</button>
                </div>

                <div id="add-password-form" class="add-password-form">
                    <h3 style="margin-bottom: 15px;">Add New Password</h3>
                    <form id="password-form">
                        <div class="form-group">
                            <label for="site-name">Site/Service Name</label>
                            <input type="text" id="site-name" placeholder="e.g., Gmail, Facebook, Bank" required>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="username">Username/Email</label>
                                <input type="text" id="username" placeholder="your@email.com">
                            </div>
                            
                            <div class="form-group">
                                <label for="password">Password</label>
                                <input type="password" id="password" required>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="url">Website URL (optional)</label>
                            <input type="url" id="url" placeholder="https://example.com">
                        </div>
                        
                        <div class="form-group">
                            <label for="notes">Notes (optional)</label>
                            <input type="text" id="notes" placeholder="Additional notes or security questions">
                        </div>
                        
                        <button type="submit" class="btn btn-primary">Save Password</button>
                        <button type="button" id="cancel-add" class="btn btn-secondary">Cancel</button>
                    </form>
                </div>

                <div id="password-list" class="password-list">
                    <h3>Your Passwords</h3>
                    <div id="passwords-container">
                        <p style="color: #6c757d; text-align: center; padding: 40px;">Vault is locked or empty. Please unlock or initialize.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        class PasswordManager {
            constructor() {
                this.passwords = [];
                this.githubToken = '';
                this.repoOwner = '';
                this.repoName = '';
                this.masterPassword = '';
                this.isInitialized = false;
                this.init(); // Load state is now part of init
            }

            init() {
                this.loadState(); // <-- Load previous state (token/repo/initialized flag)
                this.bindEvents();
            }

            bindEvents() {
    // FIX: Use .bind(this) for methods attached to form events 
    // to ensure 'this' refers to the PasswordManager instance.
    document.getElementById('setup-form').addEventListener('submit', this.handleSetup.bind(this));
    document.getElementById('login-form').addEventListener('submit', this.handleLogin.bind(this)); 
    document.getElementById('reset-setup').addEventListener('click', this.resetSetup.bind(this));
    
    // Existing handlers that use arrow functions (which maintain 'this' scope) are fine:
    document.getElementById('password-form').addEventListener('submit', (e) => this.handleAddPassword(e));
    document.getElementById('add-password-btn').addEventListener('click', () => this.showAddForm());
    document.getElementById('cancel-add').addEventListener('click', () => this.hideAddForm());
    document.getElementById('sync-btn').addEventListener('click', () => this.syncWithGitHub());
    document.getElementById('logout-btn').addEventListener('click', () => this.logout());
    document.getElementById('export-btn').addEventListener('click', () => this.exportBackup());
}

            // --- PERSISTENCE AND STATE MANAGEMENT ---

            saveState() {
                localStorage.setItem('pm_repoOwner', this.repoOwner);
                localStorage.setItem('pm_repoName', this.repoName);
                localStorage.setItem('pm_isInitialized', this.isInitialized);
                // The GitHub token is saved to avoid re-entering, but the Master Password is NOT saved.
                localStorage.setItem('pm_githubToken', this.githubToken); 
            }

            loadState() {
                this.repoOwner = localStorage.getItem('pm_repoOwner') || '';
                this.repoName = localStorage.getItem('pm_repoName') || '';
                this.isInitialized = localStorage.getItem('pm_isInitialized') === 'true';
                this.githubToken = localStorage.getItem('pm_githubToken') || ''; // Load token from storage

                if (this.isInitialized) {
                    this.showLoginSection();
                } else {
                    this.showSetupSection();
                }
            }
            
            resetState() {
                localStorage.removeItem('pm_repoOwner');
                localStorage.removeItem('pm_repoName');
                localStorage.removeItem('pm_isInitialized');
                localStorage.removeItem('pm_githubToken');
            }

            async handleSetup(e) {
                e.preventDefault();
                
                this.githubToken = document.getElementById('github-token').value;
                this.repoOwner = document.getElementById('repo-owner').value;
                this.repoName = document.getElementById('repo-name').value;
                this.masterPassword = document.getElementById('master-password').value; // Master password is read for immediate use

                if (!this.masterPassword || !this.githubToken) {
                     this.showStatus('All fields must be filled.', 'error');
                     return;
                }

                try {
                    this.showStatus('Testing GitHub connection and loading vault...', 'info');

                    // 1. Test GitHub connection
                    await this.testGitHubConnection();
                    
                    // 2. Load existing data (decrypt will use the entered masterPassword)
                    await this.loadFromGitHub(false); // Do not throw error if file is missing
                    
                    // 3. Save setup and switch to main view
                    this.isInitialized = true;
                    this.saveState();
                    this.showMainSection();
                    this.showStatus('Setup complete! Vault unlocked.', 'success');
                    
                    // Clear the setup form fields
                    document.getElementById('setup-form').reset();
                    document.getElementById('master-password').value = ''; // Ensure MP field is cleared
                } catch (error) {
                    this.isInitialized = false;
                    this.showStatus('Setup failed: ' + error.message, 'error');
                }
            }

            // --- NEW LOGIN HANDLER ---
            async handleLogin(e) {
                e.preventDefault();
                // Get MP from the login form
                this.masterPassword = document.getElementById('login-master-password').value;
                
                if (!this.masterPassword) {
                     this.showStatus('Please enter your Master Password.', 'error');
                     return;
                }
                
                // We rely on the stored token (this.githubToken) and repo details
                
                try {
                    this.showStatus('Attempting to decrypt vault...', 'info');
                    
                    // Attempt to load and decrypt the vault. This will fail if the MP is wrong.
                    await this.loadFromGitHub(true); 
                    
                    this.showMainSection();
                    this.showStatus('Vault unlocked successfully!', 'success');
                    document.getElementById('login-form').reset();
                } catch (error) {
                    // This error is crucial: it means the decryption failed (wrong MP) or the file is missing/corrupt.
                    this.showStatus('Unlock failed: Incorrect Master Password or file issue. You may need to Reset Setup.', 'error');
                    this.passwords = [];
                    this.renderPasswords();
                }
            }

            // --- NEW RESET HANDLER ---
            resetSetup() {
                if (confirm('WARNING: This will erase all local settings (Token, Repo details) and force a full re-setup. Your passwords will remain on GitHub, but you will need your Master Password and Token to recover them. Continue?')) {
                    this.resetState(); // Clear all local storage keys
                    this.isInitialized = false;
                    this.masterPassword = '';
                    this.passwords = [];
                    this.renderPasswords(); // Clear the visible list
                    this.showSetupSection();
                    this.showStatus('Local setup cleared. Please initialize the manager again.', 'info');
                }
            }

            // --- SECTION HANDLERS MODIFIED ---

            showSetupSection() {
                document.getElementById('setup-section').classList.add('active');
                document.getElementById('login-section').classList.remove('active');
                document.getElementById('main-section').classList.remove('active');
            }

            showLoginSection() {
                document.getElementById('setup-section').classList.remove('active');
                document.getElementById('login-section').classList.add('active');
                document.getElementById('main-section').classList.remove('active');
            }

            showMainSection() {
                document.getElementById('setup-section').classList.remove('active');
                document.getElementById('login-section').classList.remove('active');
                document.getElementById('main-section').classList.add('active');
                this.renderPasswords();
            }

            // --- CORE METHODS MODIFIED ---

            async testGitHubConnection() {
                const response = await fetch(`https://api.github.com/repos/${this.repoOwner}/${this.repoName}`, {
                    headers: {
                        'Authorization': `Bearer ${this.githubToken}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });

                if (!response.ok) {
                    throw new Error('Could not access repository. Check your token and repository details.');
                }
            }

            // isUnlock flag added to control error throwing when the file is not found (first time setup)
            async loadFromGitHub(isUnlock = false) {
                try {
                    const response = await fetch(`https://api.github.com/repos/${this.repoOwner}/${this.repoName}/contents/passwords.json`, {
                        headers: {
                            'Authorization': `Bearer ${this.githubToken}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    });

                    if (response.ok) {
                        const data = await response.json();
                        const encryptedData = atob(data.content);
                        const decryptedData = await this.decrypt(encryptedData); // THIS IS WHERE THE WRONG MP FAILS
                        this.passwords = JSON.parse(decryptedData);
                        this.updateSyncStatus(true);
                        return true;
                    } else if (response.status === 404 && !isUnlock) {
                        // File doesn't exist yet, that's okay for initial setup.
                        this.passwords = [];
                        console.log('No existing password file found, starting fresh');
                        return false;
                    } else {
                        // All other errors (including 404 on unlock) are treated as failures.
                        throw new Error(`Failed to load vault (Status: ${response.status})`);
                    }
                } catch (error) {
                    // Catch decryption failure (wrong MP) or network errors
                    this.updateSyncStatus(false);
                    throw new Error('Vault access failed: ' + error.message);
                }
            }

            // ... (rest of the methods remain the same) ...

            // logout method updated to reset everything
            logout() {
                if (confirm('Are you sure you want to lock the vault? Make sure your passwords are synced!')) {
                    this.passwords = [];
                    this.masterPassword = ''; // Clear Master Password from memory
                    // Keep Token/Repo details in localStorage so we go to login next time
                    this.showLoginSection(); 
                    this.showStatus('Vault locked.', 'info');
                }
            }

            // ... (rest of the methods: renderPasswords, deletePassword, copyToClipboard, exportBackup, escapeHtml, encrypt, decrypt, getEncryptionKey) ...

        }

        // Initialize the password manager
        const passwordManager = new PasswordManager();

        // --- PWA Service Worker Registration ---

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                // Use a relative path to register
                navigator.serviceWorker.register('./service-worker.js')
                    .then(registration => {
                        console.log('Service Worker registered:', registration.scope);
                    })
                    .catch(error => {
                        console.log('Service Worker registration failed:', error);
                    });
            });
        }
    </script>
</body>
</html>